<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary-blue: #0a2463; --secondary-blue: #1e5095; --primary-red: #d90429;
            --text-light: #ffffff; --card-bg: #1a3a7a; --border-color: #3b5a9d; --gold-star: #FFD700;
        }
        body { background-color: var(--primary-blue); color: var(--text-light); padding-top: 56px; }
        .bg-dark-blue { background-color: #051438 !important; border-bottom: 2px solid var(--primary-red); }
        .main-title { color: var(--text-light); border-left: 4px solid var(--primary-red); padding-left: 1rem; }
        .athlete-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .athlete-card-clickable { cursor: pointer; }
        .athlete-card-clickable:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(217, 4, 41, 0.2); border-color: var(--primary-red); }
        .athlete-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--border-color); object-fit: cover; background-color: var(--secondary-blue); }
        .shirt-number { font-size: 1.5rem; font-weight: bold; color: var(--text-light); background-color: var(--primary-red); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; top: 15px; right: 15px; }
        .is-captain { color: var(--gold-star); }
        .card-actions { position: absolute; bottom: 10px; right: 10px; z-index: 5; display: flex; gap: 5px; }
        .card-actions .btn { background: rgba(0,0,0,0.3); border: none; }
        .chart-card, .table-card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .modal-content { background-color: var(--primary-blue); border: 1px solid var(--primary-red); }
        .modal-header, .modal-footer { border-bottom: 1px solid var(--border-color); border-top: 1px solid var(--border-color); }
        .btn-primary-custom { background-color: var(--primary-red); border-color: var(--primary-red); color: white; }
        .btn-primary-custom:hover { background-color: #b80323; border-color: #b80323; }
        .form-control, .form-select { background-color: var(--secondary-blue); color: var(--text-light); border-color: var(--border-color); }
        .form-control::placeholder { color: #8a9fc1; }
        .form-control:focus, .form-select:focus { background-color: var(--secondary-blue); color: var(--text-light); border-color: var(--primary-red); box-shadow: 0 0 0 0.25rem rgba(217, 4, 41, 0.25); }
        .award-card { background: linear-gradient(45deg, var(--gold-star), #d4af37); color: #000; border: 2px solid #fff; }
        .award-avatar { width: 60px; height: 60px; }
        .text-muted { color: rgba(255, 255, 255, 0.75) !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark-blue fixed-top">
        <div class="container-fluid"><a class="navbar-brand fw-bold" href="#"><i class="bi bi-person-workspace"></i> Coach Dashboard</a></div>
    </nav>

    <main class="container-fluid mt-5 pt-3">
        <div class="row align-items-center my-4">
            <div class="col-md-4"><h2 class="main-title">Gestione Squadra</h2></div>
            <div class="col-md-8 d-flex justify-content-md-end align-items-center flex-wrap gap-2">
                <button class="btn btn-secondary" id="export-all-data-btn"><i class="bi bi-download"></i> Esporta Dati</button>
                <label for="import-file-input" class="btn btn-secondary mb-0"><i class="bi bi-upload"></i> Importa Dati</label>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                <button class="btn btn-primary-custom" id="add-athlete-btn"><i class="bi bi-person-plus-fill"></i> Aggiungi Atleta</button>
                <div class="d-flex align-items-center gap-2">
                    <label for="evaluation-date-picker" class="form-label mb-0 text-nowrap">Data Valutazioni:</label>
                    <input type="date" id="evaluation-date-picker" class="form-control" style="max-width: 180px;">
                    <button class="btn btn-outline-danger" id="delete-day-data-btn" title="Elimina tutti i dati del giorno selezionato"><i class="bi bi-calendar-x-fill"></i></button>
                </div>
            </div>
        </div>
        <div class="row" id="athlete-grid"></div>

        <hr class="my-5">

        <div class="row my-4">
            <h2 class="main-title">Report Valutazioni Comportamentali</h2>
            <div class="col-lg-6 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Andamento Medio Squadra (Ultimi 7 Giorni)</h5><canvas id="dailyTeamChart"></canvas></div></div></div>
            <div class="col-lg-6 mb-4"><div class="card chart-card"><div class="card-body" id="comparison-chart-container"><h5 class="card-title mb-0">Confronto Valutazioni Atleti</h5><div class="btn-group btn-group-sm float-end" id="comparison-period-toggle"><button type="button" class="btn btn-outline-secondary active" data-period="daily">Giornaliero</button><button type="button" class="btn btn-outline-secondary" data-period="weekly">Settimanale</button><button type="button" class="btn btn-outline-secondary" data-period="monthly">Mensile</button></div><canvas id="monthlyComparisonChart"></canvas></div></div></div>
        </div>

        <div class="row my-4">
             <h2 class="main-title">Report Presenze Allenamenti</h2>
             <div class="col-12 mb-4">
                 <div class="card chart-card">
                     <div class="card-body">
                         <div class="d-flex justify-content-between align-items-center">
                             <h5 class="card-title mb-0">Conteggio Presenze Atleti</h5>
                             <div class="btn-group btn-group-sm" id="attendance-period-toggle">
                                 <button type="button" class="btn btn-outline-secondary active" data-period="daily">Giornaliero</button>
                                 <button type="button" class="btn btn-outline-secondary" data-period="weekly">Settimanale</button>
                                 <button type="button" class="btn btn-outline-secondary" data-period="monthly">Mensile</button>
                             </div>
                         </div>
                         <canvas id="attendanceChart"></canvas>
                     </div>
                 </div>
             </div>
        </div>

        <hr class="my-5">

        <div class="row my-4">
              <h2 class="main-title">Hall of Fame - Atleti Premiati della Stagione</h2>
              <div id="hall-of-fame-container" class="d-flex flex-wrap gap-3"></div>
        </div>

        <hr class="my-5">

        <div class="row my-4" id="multi-athlete-chart-container">
            <h2 class="main-title">Confronto Performance Squadra</h2>
            <div class="col-12 mb-4">
                <div class="card chart-card">
                    <div class="card-body">
                        <div class="row g-3 align-items-center mb-3">
                            <div class="col-md-4">
                                <label for="multi-athlete-metric-selector" class="form-label">Parametro</label>
                                <select id="multi-athlete-metric-selector" class="form-select"></select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Tipo Sessione</label>
                                <div class="btn-group w-100" id="multi-athlete-type-selector">
                                    <button type="button" class="btn btn-outline-secondary active" data-type="all">Tutti</button>
                                    <button type="button" class="btn btn-outline-secondary" data-type="Allenamento">Allenamento</button>
                                    <button type="button" class="btn btn-outline-secondary" data-type="Partita">Partita</button>
                                    <button type="button" class="btn btn-outline-secondary" data-type="Individual">Individual</button>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-8">
                                <label class="form-label">Filtro Temporale</label>
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-secondary" data-period="day">Giorno</button>
                                    <button type="button" class="btn btn-outline-secondary active" data-period="month">Mese</button>
                                    <button type="button" class="btn btn-outline-secondary" data-period="bimonth">Bimestre</button>
                                    <button type="button" class="btn btn-outline-secondary" data-period="trimester">Trimestre</button>
                                    <button type="button" class="btn btn-outline-secondary" data-period="semester">Semestre</button>
                                </div>
                            </div>
                            <div class="col-md-3" id="multi-athlete-datepicker-container" style="display: none;">
                                <label for="multi-athlete-datepicker" class="form-label">Seleziona Data</label>
                                <input type="date" id="multi-athlete-datepicker" class="form-control">
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-secondary w-100" id="multi-athlete-reset-btn" title="Reset Filtri"><i class="bi bi-arrow-clockwise"></i></button>
                            </div>
                        </div>
                        <canvas id="multiAthleteChart" class="mt-4"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <hr class="my-5">

        <div class="row my-4">
            <h2 class="main-title">Monitoraggio Performance (GPS)</h2>
            <div class="card chart-card p-3 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <label class="form-label mb-0">Filtra sessioni per tipo:</label>
                    <div class="btn-group btn-group-sm" id="performance-filter-toggle">
                        <button type="button" class="btn btn-outline-secondary active" data-type="all">Tutti</button>
                        <button type="button" class="btn btn-outline-secondary" data-type="Allenamento">Allenamento</button>
                        <button type="button" class="btn btn-outline-secondary" data-type="Partita">Partita</button>
                        <button type="button" class="btn btn-outline-secondary" data-type="Individual">Individual</button>
                    </div>
                </div>
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label class="form-label">Seleziona le sessioni da confrontare:</label>
                        <div id="performance-selectors-container" class="d-grid gap-2"></div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end gap-2 mt-2 mt-md-0">
                        <div>
                            <label for="performance-metric-selector" class="form-label">Metrica:</label>
                            <select id="performance-metric-selector" class="form-select"></select>
                        </div>
                        <button class="btn btn-primary-custom flex-grow-1" id="add-comparison-btn"><i class="bi bi-plus-lg"></i> Aggiungi</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-7 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Grafico Confronto Performance</h5><canvas id="performanceChart"></canvas></div></div></div>
            <div class="col-lg-5 mb-4"><div class="card table-card"><div class="card-body"><h5 class="card-title">Tabella Dati a Confronto</h5><div class="table-responsive" id="performance-table-container"></div><div id="export-buttons-container" class="mt-3 d-flex gap-2"></div></div></div></div>
        </div>

        <hr class="my-5">

        <div class="row my-4">
            <h2 class="main-title">Analisi Atleta Singolo</h2>
            <div class="card chart-card p-3 mb-4">
                <div class="row">
                    <div class="col-md-6">
                        <label for="trend-athlete-selector" class="form-label">Atleta per Andamento nel Tempo:</label>
                        <select id="trend-athlete-selector" class="form-select"></select>
                        <label for="trend-metric-selector" class="form-label mt-2">Metrica per Andamento:</label>
                        <select id="trend-metric-selector" class="form-select"></select>
                    </div>
                    <div class="col-md-6">
                        <label for="radar-athlete-selector-1" class="form-label">Atleta 1 (Radar):</label>
                        <select id="radar-athlete-selector-1" class="form-select"></select>
                        <label for="radar-athlete-selector-2" class="form-label mt-2">Atleta 2 (Confronto Radar):</label>
                        <select id="radar-athlete-selector-2" class="form-select"></select>
                    </div>
                </div>
            </div>
            <div class="col-lg-8 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Andamento Performance nel Tempo</h5><canvas id="athleteTrendChart"></canvas></div></div></div>
            <div class="col-lg-4 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Profilo Atleta (vs. Top di Squadra)</h5><canvas id="athleteRadarChart"></canvas></div></div></div>
        </div>
    </main>

    <footer class="bg-dark-blue py-3 mt-5">
        <div class="container text-center">
            <p class="text-muted mb-0">By Edy Franzoso</p>
        </div>
    </footer>

    <div id="modals-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const modalsContainer = document.getElementById('modals-container');
        modalsContainer.innerHTML = `
            <div class="modal fade" id="evaluationModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Valutazione di <span id="modal-athlete-name-eval"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="evaluation-form"><input type="hidden" id="modal-athlete-id-eval"><p>Data: <strong id="modal-evaluation-date"></strong></p><div class="mb-2"><label class="form-label">Presenza Allenamento</label><select id="presenza-allenamento" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Serietà Allenamento</label><select id="serieta-allenamento" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Abbigliamento Allenamento</label><select id="abbigliamento-allenamento" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Abbigliamento Partita</label><select id="abbigliamento-partita" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Serietà Comunicazioni</label><select id="comunicazioni" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Doccia (Opzionale)</label><select id="doccia" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="award-checkbox"><label class="form-check-label" for="award-checkbox">Assegna Premio</label></div></form></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-outline-danger" id="delete-single-athlete-day-btn">Elimina Dati del Giorno</button><div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button><button type="submit" class="btn btn-primary-custom" form="evaluation-form">Salva Valutazione</button></div></div></div></div></div>
            <div class="modal fade" id="athleteModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="athleteModalLabel">Gestisci Atleta</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="athlete-form"><input type="hidden" id="modal-athlete-id"><div class="mb-3"><label class="form-label">Nome Cognome</label><input type="text" class="form-control" id="athlete-name" required></div><div class="mb-3"><label class="form-label">URL Foto Profilo</label><input type="url" class="form-control" id="athlete-avatar" placeholder="https://esempio.com/foto.png"></div><div class="mb-3"><label class="form-label">Ruolo</label><input type="text" class="form-control" id="athlete-role" required></div><div class="mb-3"><label class="form-label">Numero Maglia</label><input type="number" class="form-control" id="athlete-number" required min="1"></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="athlete-captain"><label class="form-check-label" for="athlete-captain">Capitano</label></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="submit" class="btn btn-primary-custom" form="athlete-form">Salva Atleta</button></div></div></div></div>
            <div class="modal fade" id="gpsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="gpsModalLabel">Dati Performance di <span id="modal-athlete-name-gps"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="gps-form"><input type="hidden" id="modal-athlete-id-gps">
                <div class="row mb-3"><div class="col-md-8"><label for="gps-session-selector" class="form-label">Seleziona Sessione Esistente per Modificare</label><select id="gps-session-selector" class="form-select"><option value="">--- Inserisci Nuova Sessione ---</option></select></div><div class="col-md-4 d-flex align-items-end"><button type="button" id="delete-gps-session-btn" class="btn btn-outline-danger w-100" disabled>Elimina Sessione</button></div></div><hr>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Data Registrazione</label><input type="date" class="form-control" id="gps-data_di_registrazione" required></div><div class="col-md-4 mb-3"><label class="form-label">Tipo Sessione</label><select class="form-select" id="gps-tipo_sessione"><option value="Allenamento">Allenamento</option><option value="Partita">Partita</option><option value="Individual">Individual</option></select></div><div class="col-md-4 mb-3"><label class="form-label">Distanza Totale (m)</label><input type="number" step="0.1" class="form-control" id="gps-distanza_totale" placeholder="es. 10500"></div></div>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Tempo Totale (min)</label><input type="number" step="0.1" class="form-control" id="gps-tempo_totale" placeholder="es. 92"></div><div class="col-md-4 mb-3"><label class="form-label">Distanza Sprint (m)</label><input type="number" step="0.1" class="form-control" id="gps-distanza_sprint"></div><div class="col-md-4 mb-3"><label class="form-label">Velocità Massima (km/h)</label><input type="number" step="0.1" class="form-control" id="gps-velocita_massima"></div></div>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Numero di Sprint</label><input type="number" class="form-control" id="gps-numero_di_sprint"></div><div class="col-md-4 mb-3"><label class="form-label">Max Acc (g)o(n°)</label><input type="number" step="0.1" class="form-control" id="gps-max_acc"></div><div class="col-md-4 mb-3"><label class="form-label">Max Dec (g)o(n°)</label><input type="number" step="0.1" class="form-control" id="gps-max_dec"></div></div>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Passaggi Piede Sinistro</label><input type="number" class="form-control" id="gps-passaggi_piede_sinistro"></div><div class="col-md-4 mb-3"><label class="form-label">Passaggi Piede Destro</label><input type="number" class="form-control" id="gps-passaggi_piede_destro"></div><div class="col-md-4 mb-3"><label class="form-label">Cross Piede Sinistro</label><input type="number" step="0.1" class="form-control" id="gps-cross_piede_sinistro"></div></div>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Cross Piede Destro</label><input type="number" step="0.1" class="form-control" id="gps-cross_piede_destro"></div><div class="col-md-4 mb-3"><label class="form-label">Potenza Massima di Tiro (km/h)</label><input type="number" step="0.1" class="form-control" id="gps-potenza_massima_di_tiro"></div><div class="col-md-4 mb-3"><label class="form-label">Distanza per Minuto (m/min)</label><input type="number" step="0.1" class="form-control" id="gps-distanza_per_minuto" readonly></div></div>
                <div class="row"><div class="col-md-3 mb-3"><label class="form-label">Tiri Piede SX</label><input type="number" class="form-control" id="gps-tiri_piede_sx"></div><div class="col-md-3 mb-3"><label class="form-label">Tiri Piede DX</label><input type="number" class="form-control" id="gps-tiri_piede_dx"></div><div class="col-md-3 mb-3"><label class="form-label">% Passaggi Brevi</label><input type="number" step="0.1" class="form-control" id="gps-perc_passaggi_brevi"></div><div class="col-md-3 mb-3"><label class="form-label">% Lanci</label><input type="number" step="0.1" class="form-control" id="gps-perc_lanci"></div></div>

                <hr><h5 class="mb-3">Dati Circuiti</h5>
                <div class="row align-items-end">
                    <div class="col-md-3 mb-3"><label class="form-label">Distanza Circuito (m)</label><input type="number" step="1" class="form-control" id="gps-distanza_circuito" placeholder="es. 400"></div>
                    <div class="col-md-5 mb-3"><label class="form-label">Tempo Circuito</label><div class="input-group"><input type="number" class="form-control" id="gps-tempo_circuito_min" placeholder="Min" min="0"><span class="input-group-text">:</span><input type="number" class="form-control" id="gps-tempo_circuito_sec" placeholder="Sec" min="0" max="59"><span class="input-group-text">.</span><input type="number" class="form-control" id="gps-tempo_circuito_cen" placeholder="Cen" min="0" max="99"></div></div>
                    <div class="col-md-4 mb-3"><label class="form-label">Velocità (km/h)</label><input type="text" class="form-control" id="gps-velocita_circuito" readonly></div>
                </div>

            </form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button><button type="submit" class="btn btn-primary-custom" form="gps-form">Salva Dati GPS</button></div></div></div></div>
        `;

        const evaluationModal = new bootstrap.Modal(document.getElementById('evaluationModal'));
        const athleteModal = new bootstrap.Modal(document.getElementById('athleteModal'));
        const gpsModal = new bootstrap.Modal(document.getElementById('gpsModal'));

        const elements = {
            athleteGrid: document.getElementById('athlete-grid'),
            evaluationDatePicker: document.getElementById('evaluation-date-picker'),
            performanceSelectorsContainer: document.getElementById('performance-selectors-container'),
            addComparisonBtn: document.getElementById('add-comparison-btn'),
            evaluationForm: document.getElementById('evaluation-form'),
            athleteForm: document.getElementById('athlete-form'),
            gpsForm: document.getElementById('gps-form'),
            addAthleteBtn: document.getElementById('add-athlete-btn'),
            comparisonPeriodToggle: document.getElementById('comparison-period-toggle'),
            attendancePeriodToggle: document.getElementById('attendance-period-toggle'),
            metricSelector: document.getElementById('performance-metric-selector'),
            tableContainer: document.getElementById('performance-table-container'),
            exportButtonsContainer: document.getElementById('export-buttons-container'),
            trendAthleteSelector: document.getElementById('trend-athlete-selector'),
            trendMetricSelector: document.getElementById('trend-metric-selector'),
            hallOfFameContainer: document.getElementById('hall-of-fame-container'),
            radarAthleteSelector1: document.getElementById('radar-athlete-selector-1'),
            radarAthleteSelector2: document.getElementById('radar-athlete-selector-2'),
            multiAthleteMetricSelector: document.getElementById('multi-athlete-metric-selector'),
            multiAthleteTimeFilter: document.querySelector('#multi-athlete-chart-container .btn-group[role="group"]'),
            multiAthleteDatepicker: document.getElementById('multi-athlete-datepicker'),
            multiAthleteDatepickerContainer: document.getElementById('multi-athlete-datepicker-container'),
            multiAthleteResetBtn: document.getElementById('multi-athlete-reset-btn'),
            deleteDayDataBtn: document.getElementById('delete-day-data-btn'),
            exportAllDataBtn: document.getElementById('export-all-data-btn'),
            importFileInput: document.getElementById('import-file-input'),
            performanceFilterToggle: document.getElementById('performance-filter-toggle'),
            multiAthleteTypeSelector: document.getElementById('multi-athlete-type-selector'),
        };

        const allGpsFields = ['data_di_registrazione', 'tipo_sessione', 'distanza_totale', 'tempo_totale', 'distanza_sprint', 'velocita_massima', 'numero_di_sprint', 'max_acc', 'max_dec', 'passaggi_piede_sinistro', 'passaggi_piede_destro', 'cross_piede_sinistro', 'cross_piede_destro', 'potenza_massima_di_tiro', 'distanza_per_minuto', 'tiri_piede_sx', 'tiri_piede_dx', 'perc_passaggi_brevi', 'perc_lanci', 'distanza_circuito', 'tempo_circuito_totale_s', 'velocita_circuito'];
        const gpsFieldsForDisplay = { 'tipo_sessione':'Tipo', 'distanza_totale': 'Dist. Totale (m)', 'tempo_totale': 'Tempo (min)', 'distanza_per_minuto':'Dist/min (m)', 'distanza_sprint': 'Distanza Sprint (m)', 'velocita_massima': 'Vel. Max (km/h)', 'numero_di_sprint': 'Num. Sprint', 'max_acc': 'Max Acc (g)o(n°)', 'max_dec': 'Max Dec (g)o(n°)', 'passaggi_piede_sinistro':'Passaggi SX', 'passaggi_piede_destro':'Passaggi DX', 'cross_piede_sinistro':'Cross SX', 'cross_piede_destro':'Cross DX', 'potenza_massima_di_tiro':'Pot. Tiro (km/h)', 'tiri_piede_sx': 'Tiri Piede SX', 'tiri_piede_dx': 'Tiri Piede DX', 'perc_passaggi_brevi': '% Passaggi Brevi', 'perc_lanci': '% Lanci', 'distanza_circuito': 'Dist. Circuito (m)', 'tempo_circuito_totale_s': 'Tempo Circuito (s)', 'velocita_circuito': 'Vel. Circuito (km/h)' };
        const radarMetrics = { 'distanza_sprint': 'Distanza Sprint', 'velocita_massima': 'Vel. Max', 'max_acc': 'Max Acc', 'max_dec': 'Max Dec', 'passaggi_piede_sinistro': 'Pass. SX', 'passaggi_piede_destro': 'Pass. DX', 'cross_piede_sinistro': 'Cross SX', 'cross_piede_destro': 'Cross DX', 'potenza_massima_di_tiro': 'Pot. Tiro', 'distanza_per_minuto': 'Dist/min', 'tiri_piede_sx': 'Tiri SX', 'tiri_piede_dx': 'Tiri DX', 'perc_passaggi_brevi': '% Pass. Brevi', 'perc_lanci': '% Lanci', 'velocita_circuito': 'Vel. Circuito' };

        const evaluationCategories = ['presenza-allenamento', 'serieta-allenamento', 'abbigliamento-allenamento', 'abbigliamento-partita', 'comunicazioni', 'doccia'];
        const defaultAvatar = "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3e%3cpath fill='%231e5095' d='M128 128H0V0h128v128z'/%3e%3cpath fill='%23ffffff' d='M64 100c-19.88 0-36-16.12-36-36s16.12-36 36-36 36 16.12 36 36-16.12 36-36 36zm0-64c-15.46 0-28 12.54-28 28s12.54 28 28 28 28-12.54 28-28-12.54-28-28-28z'/%3e%3cpath fill='%23ffffff' d='M64 24a40.01 40.01 0 00-28.28 11.72C35.8 35.8 28 45.45 28 56h8c0-8.27 5.61-15.64 13.53-18.89A31.93 31.93 0 0164 32a32.09 32.09 0 0124.47 11.11C96.39 40.36 102 47.73 102 56h8c0-10.55-7.8-20.2-17.72-24.28A39.99 39.99 0 0064 24z'/%3e%3c/svg%3e";

        let athletes = [], evaluations = {}, gpsData = {}, awards = {};
        let chartInstances = {};
        let comparisonChartPeriod = 'daily';
        let attendanceChartPeriod = 'daily';
        let performanceSelections = [ { athleteId: null, date: null }, { athleteId: null, date: null } ];
        let performanceFilterType = 'all';
        let multiAthleteFilterType = 'all';

        const saveData = async () => {
            const allData = { athletes, evaluations, gpsData, awards };
            try {
                await fetch('/api/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allData)
                });
            } catch (error) {
                console.error('Errore nel salvataggio dei dati sul server:', error);
            }
        };

        const loadData = async () => {
            try {
                const response = await fetch('/api/data', { cache: 'no-store' });
                if (!response.ok) throw new Error(`Errore HTTP: ${response.status}`);
                const allData = await response.json();
                athletes = allData.athletes || [];
                evaluations = allData.evaluations || {};
                gpsData = allData.gpsData || {};
                awards = allData.awards || {};
            } catch (error) {
                console.error('Errore nel caricamento dei dati dal server:', error);
                athletes = []; evaluations = {}; gpsData = {}; awards = {};
            }
        };

        const calculateAthleteScore = (evaluation) => !evaluation ? 0 : Object.keys(evaluation).filter(k => k !== 'doccia').reduce((sum, key) => sum + parseInt(evaluation[key] || 0, 10), 0);
        const getWeekRange = (date) => { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); const monday = new Date(d.setDate(diff)); const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6); return { start: monday.toISOString().split('T')[0], end: sunday.toISOString().split('T')[0] }; };

        const renderAthletes = () => {
            elements.athleteGrid.innerHTML = '';
            athletes.forEach(athlete => {
                const card = document.createElement('div');
                card.className = 'col-xl-3 col-lg-4 col-md-6 mb-4';
                card.innerHTML = `<div class="card athlete-card"><div class="card-body athlete-card-clickable" data-athlete-id="${athlete.id}"><img src="${athlete.avatar || defaultAvatar}" onerror="this.src='${defaultAvatar}'" alt="${athlete.name}" class="athlete-avatar me-3"><div><h5 class="card-title mb-0">${athlete.name} ${athlete.isCaptain ? '<i class="bi bi-star-fill is-captain"></i>' : ''}</h5><p class="card-text text-muted">${athlete.role}</p></div><div class="shirt-number">${athlete.number}</div></div><div class="card-actions"><button class="btn btn-sm btn-outline-light gps-btn" title="Dati Performance" data-athlete-id="${athlete.id}"><i class="bi bi-person-fill-gear"></i></button><button class="btn btn-sm btn-outline-light edit-btn" title="Modifica Atleta" data-athlete-id="${athlete.id}"><i class="bi bi-pencil-fill"></i></button><button class="btn btn-sm btn-outline-light delete-btn" title="Elimina Atleta" data-athlete-id="${athlete.id}"><i class="bi bi-trash-fill"></i></button></div></div>`;
                elements.athleteGrid.appendChild(card);
            });
        };

        const updateAllUI = () => {
            renderAthletes();
            updateEvaluationCharts();
            updateAttendanceChart();
            updateHallOfFame();
            populatePerformanceSelectors();
            populateAnalysisSelectors();
            updatePerformanceChart();
            updateAthleteTrendChart();
            updateAthleteRadarChart();
            updateMultiAthleteChart();
        }

        const updateEvaluationCharts = () => {
            const date = elements.evaluationDatePicker.value;
            if (!date) return;
            const last7Days = Array.from({length: 7}, (_, i) => new Date(Date.now() - i * 864e5).toISOString().split('T')[0]).reverse();
            const teamDailyAvgScores = last7Days.map(d => { let total = 0, count = 0; if (evaluations[d]) { Object.values(evaluations[d]).forEach(ev => { total += calculateAthleteScore(ev); count++; }); } return count > 0 ? (total / count).toFixed(2) : 0; });
            if(chartInstances.dailyTeam) chartInstances.dailyTeam.destroy();
            chartInstances.dailyTeam = new Chart(document.getElementById('dailyTeamChart').getContext('2d'), {
                type: 'line', 
                data: {
                    labels: last7Days.map(d => new Date(d).toLocaleDateString('it-IT', {day:'2-digit', month:'short'})), 
                    datasets: [{ label: 'Punteggio Medio', data: teamDailyAvgScores, borderColor: 'rgba(217, 4, 41, 1)', backgroundColor: 'rgba(217, 4, 41, 0.2)', tension: 0.3 }]
                },
                options: { scales: { y: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } }, x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } } }, plugins: { legend: { labels: { color: '#ffffff' } } } }
            });

            const scores = {};
            athletes.forEach(a => scores[String(a.id)] = { name: a.name, score: 0 });

            if (comparisonChartPeriod === 'daily') { if(evaluations[date]) { Object.entries(evaluations[date]).forEach(([id, ev]) => { if(scores[id]) scores[id].score += calculateAthleteScore(ev); }); } }
            else if (comparisonChartPeriod === 'monthly') { const month = date.substring(0, 7); Object.keys(evaluations).filter(d => d.startsWith(month)).forEach(d => { Object.entries(evaluations[d]).forEach(([id, ev]) => { if(scores[id]) scores[id].score += calculateAthleteScore(ev); }); }); }
            else { const week = getWeekRange(date); Object.keys(evaluations).filter(d => d >= week.start && d <= week.end).forEach(d => { Object.entries(evaluations[d]).forEach(([id, ev]) => { if(scores[id]) scores[id].score += calculateAthleteScore(ev); }); }); }

            const allSortedScores = Object.values(scores).filter(a => a.score > 0).sort((a, b) => b.score - a.score);
            let scoresToShow = allSortedScores;
            if (allSortedScores.length > 20) {
                const cutoffScore = allSortedScores[19].score; 
                scoresToShow = allSortedScores.filter(a => a.score >= cutoffScore);
            }

            const canvas = document.getElementById('monthlyComparisonChart');
            if(chartInstances.monthlyComparison) chartInstances.monthlyComparison.destroy();
            chartInstances.monthlyComparison = new Chart(canvas.getContext('2d'), {
                type: 'bar', 
                data: {
                    labels: scoresToShow.map(a=>a.name), 
                    datasets: [{ label: 'Punteggio Totale', data: scoresToShow.map(a=>a.score), backgroundColor: 'rgba(217, 4, 41, 0.8)' }]
                }, 
                options: {
                    indexAxis: 'y', 
                    scales: {
                        y: { ticks: { color: '#ffffff', font: { size: 9 }, autoSkip: false }, grid: { color: 'rgba(241, 241, 241, 0.2)' } },
                        x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } }
                    },
                    plugins: { legend: { labels: { color: '#ffffff' } } }
                }
            });
        };

        const updateAttendanceChart = () => {
            const date = elements.evaluationDatePicker.value;
            if (!date) return;
            const attendanceData = {};
            athletes.forEach(a => attendanceData[String(a.id)] = { name: a.name, count: 0 });
            if (attendanceChartPeriod === 'daily') {
                if (evaluations[date]) { Object.entries(evaluations[date]).forEach(([id, ev]) => { if (attendanceData[id] && ev['presenza-allenamento'] && parseInt(ev['presenza-allenamento'], 10) > 0) { attendanceData[id].count = 1; } }); }
            } else if (attendanceChartPeriod === 'monthly') {
                const month = date.substring(0, 7);
                Object.keys(evaluations).filter(d => d.startsWith(month)).forEach(d => { Object.entries(evaluations[d]).forEach(([id, ev]) => { if (attendanceData[id] && ev['presenza-allenamento'] && parseInt(ev['presenza-allenamento'], 10) > 0) { attendanceData[id].count++; } }); });
            } else {
                const week = getWeekRange(date);
                Object.keys(evaluations).filter(d => d >= week.start && d <= week.end).forEach(d => { Object.entries(evaluations[d]).forEach(([id, ev]) => { if (attendanceData[id] && ev['presenza-allenamento'] && parseInt(ev['presenza-allenamento'], 10) > 0) { attendanceData[id].count++; } }); });
            }
            const sortedAttendance = Object.values(attendanceData).sort((a, b) => b.count - a.count);
            if(chartInstances.attendance) chartInstances.attendance.destroy();
            chartInstances.attendance = new Chart(document.getElementById('attendanceChart').getContext('2d'), {
                type: 'bar',
                data: { labels: sortedAttendance.map(a => a.name), datasets: [{ label: 'Presenze', data: sortedAttendance.map(a => a.count), backgroundColor: 'rgba(217, 4, 41, 0.8)' }] },
                options: { scales: { y: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } }, x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } } }, plugins: { legend: { labels: { color: '#ffffff' } } } }
            });
        };

        const updateHallOfFame = () => {
            elements.hallOfFameContainer.innerHTML = '';
            const allAwards = Object.values(awards).flat();
            if (allAwards.length === 0) { elements.hallOfFameContainer.innerHTML = '<p class="text-muted">Nessun premio assegnato per questa stagione.</p>'; return; }
            allAwards.forEach(award => {
                const athlete = athletes.find(a => a.id.toString() === award.athleteId.toString());
                if (athlete) {
                    const awardCard = document.createElement('div');
                    awardCard.className = 'card award-card p-3 text-center';
                    awardCard.style.minWidth = '200px';

                    const dateObj = new Date(award.date);
                    const formattedDate = !isNaN(dateObj) ? dateObj.toLocaleDateString('it-IT') : 'Data non disponibile';

                    awardCard.innerHTML = `
                        <img src="${athlete.avatar || defaultAvatar}" onerror="this.src='${defaultAvatar}'" alt="${athlete.name}" class="award-avatar mx-auto mb-2 rounded-circle">
                        <h6 class="mb-1">${athlete.name}</h6>
                        <p class="mb-0" style="font-size: 0.8rem; color: #000;">${formattedDate}</p>
                        <small>${award.reason}</small>
                        <i class="bi bi-trophy-fill mt-2" style="font-size: 1.5rem;"></i>
                    `;
                    elements.hallOfFameContainer.appendChild(awardCard);
                }
            });
        };

        const populatePerformanceSelectors = () => {
            elements.performanceSelectorsContainer.innerHTML = '';
            performanceSelections.forEach((selection, index) => {
                const selectorRow = document.createElement('div');
                selectorRow.className = 'row g-2 align-items-end mb-2';
                selectorRow.innerHTML = `<div class="col-md-6"><label class="form-label">Atleta ${index + 1}:</label><select class="form-select athlete-selector" data-index="${index}"><option value="">Seleziona atleta...</option>${athletes.map(a => `<option value="${a.id}" ${selection.athleteId == a.id ? 'selected' : ''}>${a.name}</option>`).join('')}</select></div><div class="col-md-5"><label class="form-label">Sessione:</label><select class="form-select date-selector" data-index="${index}"><option value="">Seleziona sessione...</option></select></div><div class="col-md-1"><button class="btn btn-outline-danger btn-sm remove-selector" data-index="${index}" ${performanceSelections.length <= 2 ? 'disabled' : ''}><i class="bi bi-trash"></i></button></div>`;
                elements.performanceSelectorsContainer.appendChild(selectorRow);
                const athleteId = selection.athleteId;
                const dateSelector = selectorRow.querySelector('.date-selector');
                if (athleteId && gpsData[athleteId]) {
                    const allSessions = Object.entries(gpsData[athleteId]);
                    const filteredSessions = (performanceFilterType === 'all')
                        ? allSessions
                        : allSessions.filter(([, session]) => session.tipo_sessione === performanceFilterType);

                    filteredSessions
                        .sort(([dateA], [dateB]) => new Date(dateB) - new Date(dateA))
                        .forEach(([date, session]) => {
                            const option = document.createElement('option');
                            option.value = date;
                            option.textContent = `${new Date(date).toLocaleDateString('it-IT')} - ${session.tipo_sessione || 'N/A'}`;
                            if (selection.date === date) option.selected = true;
                            dateSelector.appendChild(option);
                        });
                }
            });
            elements.metricSelector.innerHTML = Object.entries(gpsFieldsForDisplay).filter(([key]) => key !== 'tipo_sessione').map(([key, label]) => `<option value="${key}">${label}</option>`).join('');
            elements.multiAthleteMetricSelector.innerHTML = Object.entries(gpsFieldsForDisplay).filter(([key]) => key !== 'tipo_sessione').map(([key, label]) => `<option value="${key}">${label}</option>`).join('');
        };

        const updatePerformanceChart = () => {
            const selectedMetric = elements.metricSelector.value;
            if (!selectedMetric) return;
            const validSelections = performanceSelections.filter(s => s.athleteId && s.date);
            if (validSelections.length === 0) { if (chartInstances.performance) chartInstances.performance.destroy(); updatePerformanceTable(); return; }
            const chartData = {
                labels: validSelections.map((selection) => { const athlete = athletes.find(a => a.id.toString() === selection.athleteId.toString()); return `${athlete?.name || 'N/A'} (${new Date(selection.date).toLocaleDateString('it-IT')})`; }),
                datasets: [{ label: gpsFieldsForDisplay[selectedMetric] || selectedMetric, data: validSelections.map(selection => { const data = gpsData[selection.athleteId]?.[selection.date]; return data ? (data[selectedMetric] || 0) : 0; }), backgroundColor: 'rgba(217, 4, 41, 0.8)' }]
            };
            if (chartInstances.performance) chartInstances.performance.destroy();
            chartInstances.performance = new Chart(document.getElementById('performanceChart').getContext('2d'), { type: 'bar', data: chartData, options: { scales: { y: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } }, x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } } }, plugins: { legend: { labels: { color: '#ffffff' } } } } });
            updatePerformanceTable();
        };

        const updatePerformanceTable = () => {
            const validSelections = performanceSelections.filter(s => s.athleteId && s.date);
            if (validSelections.length === 0) { elements.tableContainer.innerHTML = '<p class="text-muted">Nessun dato da visualizzare</p>'; elements.exportButtonsContainer.innerHTML = ''; return; }
            elements.tableContainer.innerHTML = `<table class="table table-dark table-striped table-hover"><thead><tr><th>Atleta</th><th>Data</th>${Object.values(gpsFieldsForDisplay).map(label => `<th>${label}</th>`).join('')}</tr></thead><tbody>${validSelections.map(selection => { const athlete = athletes.find(a => a.id.toString() === selection.athleteId.toString()); const data = gpsData[selection.athleteId]?.[selection.date] || {}; return `<tr><td>${athlete?.name || 'N/A'}</td><td>${new Date(selection.date).toLocaleDateString('it-IT')}</td>${Object.keys(gpsFieldsForDisplay).map(key => `<td>${data[key] ?? 'N/A'}</td>`).join('')}</tr>`; }).join('')}</tbody></table>`;
            elements.exportButtonsContainer.innerHTML = `<button class="btn btn-success btn-sm" id="export-excel"><i class="bi bi-file-excel"></i> Excel</button><button class="btn btn-danger btn-sm" id="export-pdf"><i class="bi bi-file-pdf"></i> PDF</button>`;
        };

        const populateAnalysisSelectors = () => {
            const athleteOptions = athletes.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            elements.trendAthleteSelector.innerHTML = `<option value="">Seleziona atleta...</option>${athleteOptions}`;
            elements.radarAthleteSelector1.innerHTML = `<option value="">Seleziona atleta...</option>${athleteOptions}`;
            elements.radarAthleteSelector2.innerHTML = `<option value="">Nessun confronto</option>${athleteOptions}`;
            elements.trendMetricSelector.innerHTML = Object.entries(gpsFieldsForDisplay).filter(([key]) => key !== 'tipo_sessione').map(([key, label]) => `<option value="${key}">${label}</option>`).join('');
        };

        const updateAthleteTrendChart = () => {
            const athleteId = elements.trendAthleteSelector.value;
            const metric = elements.trendMetricSelector.value;
            if (!athleteId || !metric) { if(chartInstances.athleteTrend) chartInstances.athleteTrend.destroy(); return; }
            const athlete = athletes.find(a => a.id.toString() === athleteId);
            const athleteData = gpsData[athleteId] || {};
            const dates = Object.keys(athleteData).sort();
            const values = dates.map(date => athleteData[date][metric] || 0);
            if (chartInstances.athleteTrend) chartInstances.athleteTrend.destroy();
            chartInstances.athleteTrend = new Chart(document.getElementById('athleteTrendChart').getContext('2d'), { type: 'line', data: { labels: dates.map(d => new Date(d).toLocaleDateString('it-IT')), datasets: [{ label: gpsFieldsForDisplay[metric], data: values, borderColor: 'rgba(217, 4, 41, 1)', backgroundColor: 'rgba(217, 4, 41, 0.2)', tension: 0.3, fill: true }] }, options: { scales: { y: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } }, x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } } }, plugins: { legend: { labels: { color: '#ffffff' } }, title: { display: true, text: `Andamento: ${athlete?.name || 'N/A'}`, color: '#ffffff' } } } });
        };

        const updateAthleteRadarChart = () => {
            const athleteId1 = elements.radarAthleteSelector1.value;
            const athleteId2 = elements.radarAthleteSelector2.value;
            const selectedAthleteIds = [athleteId1, athleteId2].filter(id => id);

            if (chartInstances.athleteRadar) chartInstances.athleteRadar.destroy();
            if (selectedAthleteIds.length === 0) return;

            const radarColors = [ 'rgba(217, 4, 41, 1)', 'rgba(255, 215, 0, 1)' ];
            const teamMaxs = {};
            Object.keys(radarMetrics).forEach(metric => {
                let maxValue = 0;
                Object.values(gpsData).forEach(playerData => { Object.values(playerData).forEach(session => { const value = parseFloat(session[metric] || 0); if (value > maxValue) maxValue = value; }); });
                teamMaxs[metric] = maxValue;
            });

            const datasets = selectedAthleteIds.map((athleteId, index) => {
                const athlete = athletes.find(a => a.id.toString() === athleteId);
                const athleteData = gpsData[athleteId] || {};
                const athleteAvgs = {};
                Object.keys(radarMetrics).forEach(metric => {
                    let athleteSum = 0, athleteCount = 0;
                    Object.values(athleteData).forEach(session => { if(session[metric] !== undefined){const value = parseFloat(session[metric] || 0); athleteSum += value; athleteCount++;} });
                    athleteAvgs[metric] = athleteCount > 0 ? athleteSum / athleteCount : 0;
                });
                const normalizedData = Object.keys(radarMetrics).map(metric => teamMaxs[metric] > 0 ? (athleteAvgs[metric] / teamMaxs[metric]) * 100 : 0);
                const color = radarColors[index % radarColors.length];
                return {
                    label: athlete?.name || 'N/A', data: normalizedData, borderColor: color,
                    backgroundColor: color.replace('1)', '0.2)'), pointBackgroundColor: color, pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff', pointHoverBorderColor: color
                };
            });

            chartInstances.athleteRadar = new Chart(document.getElementById('athleteRadarChart').getContext('2d'), { type: 'radar', data: { labels: Object.values(radarMetrics), datasets: datasets }, options: { scales: { r: { beginAtZero: true, max: 100, ticks: { stepSize: 20, color: '#ffffff', backdropColor: 'rgba(0,0,0,0.5)' }, pointLabels: { color: '#ffffff', font: {size: 10} }, grid: { color: 'rgba(241, 241, 241, 0.2)' }, angleLines: { color: 'rgba(241, 241, 241, 0.2)' } } }, plugins: { legend: { labels: { color: '#ffffff' } } } } });
        };

        const updateMultiAthleteChart = () => {
            const metric = elements.multiAthleteMetricSelector.value;
            const periodBtn = document.querySelector('#multi-athlete-chart-container .btn-group[role="group"] .btn.active');
            if (!metric || !periodBtn) return;

            const period = periodBtn.dataset.period;
            let startDate, endDate = new Date();

            if (period === 'day') {
                if (!elements.multiAthleteDatepicker.value) return;
                startDate = new Date(elements.multiAthleteDatepicker.value);
                endDate = new Date(elements.multiAthleteDatepicker.value);
                endDate.setHours(23, 59, 59, 999);
            } else {
                const monthsToSubtract = { month: 1, bimonth: 2, trimester: 3, semester: 6 };
                startDate = new Date();
                startDate.setMonth(startDate.getMonth() - monthsToSubtract[period]);
            }
            startDate.setHours(0, 0, 0, 0);

            const chartData = [];
            athletes.forEach(athlete => {
                const athleteGpsData = gpsData[athlete.id] || {};
                const relevantSessions = Object.entries(athleteGpsData)
                    .filter(([date]) => new Date(date) >= startDate && new Date(date) <= endDate)
                    .filter(([, session]) => {
                        if (multiAthleteFilterType === 'all') return true;
                        return session.tipo_sessione === multiAthleteFilterType;
                    })
                    .filter(([, session]) => session[metric] !== undefined && session[metric] !== null && String(session[metric]).trim() !== '')
                    .map(([, session]) => parseFloat(session[metric]));

                if (relevantSessions.length > 0) {
                    const avgValue = relevantSessions.reduce((a, b) => a + b, 0) / relevantSessions.length;
                    chartData.push({ name: athlete.name, value: avgValue });
                }
            });

            chartData.sort((a, b) => b.value - a.value);

            if(chartInstances.multiAthlete) chartInstances.multiAthlete.destroy();
            chartInstances.multiAthlete = new Chart(document.getElementById('multiAthleteChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.name),
                    datasets: [{
                        label: gpsFieldsForDisplay[metric],
                        data: chartData.map(d => d.value.toFixed(2)),
                        backgroundColor: 'rgba(217, 4, 41, 0.8)'
                    }]
                },
                options: {
                    scales: {
                        y: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } },
                        x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.1)' } }
                    },
                    plugins: { legend: { display: false }, tooltip: {
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${context.parsed.y}`
                        }
                    }}
                }
            });
        };

        elements.evaluationDatePicker.addEventListener('change', () => { updateEvaluationCharts(); updateAttendanceChart(); updateHallOfFame(); });
        elements.comparisonPeriodToggle.addEventListener('click', (e) => { if (e.target.dataset.period) { elements.comparisonPeriodToggle.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); comparisonChartPeriod = e.target.dataset.period; updateEvaluationCharts(); } });
        elements.attendancePeriodToggle.addEventListener('click', (e) => { if (e.target.dataset.period) { elements.attendancePeriodToggle.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); attendanceChartPeriod = e.target.dataset.period; updateAttendanceChart(); } });
        elements.addAthleteBtn.addEventListener('click', () => { document.getElementById('athleteModalLabel').textContent = 'Aggiungi Atleta'; document.getElementById('athlete-form').reset(); document.getElementById('modal-athlete-id').value = ''; athleteModal.show(); });

        elements.athleteGrid.addEventListener('click', (e) => {
            const card = e.target.closest('[data-athlete-id]');
            if (!card) return;
            const athleteId = card.dataset.athleteId;
            const athlete = athletes.find(a => a.id.toString() === athleteId);
            if (!athlete) return;

            if (e.target.closest('.edit-btn')) {
                document.getElementById('athleteModalLabel').textContent = 'Modifica Atleta';
                document.getElementById('modal-athlete-id').value = athlete.id;
                document.getElementById('athlete-name').value = athlete.name;
                document.getElementById('athlete-avatar').value = athlete.avatar || '';
                document.getElementById('athlete-role').value = athlete.role;
                document.getElementById('athlete-number').value = athlete.number;
                document.getElementById('athlete-captain').checked = athlete.isCaptain;
                athleteModal.show();
            } else if (e.target.closest('.delete-btn')) {
                if (confirm(`Sei sicuro di voler eliminare ${athlete.name}? Tutti i suoi dati storici verranno rimossi.`)) {
                    athletes = athletes.filter(a => a.id.toString() !== athleteId);
                    for (const date in evaluations) { delete evaluations[date][athleteId]; }
                    delete gpsData[athleteId];
                    for (const date in awards) { awards[date] = awards[date].filter(a => a.athleteId.toString() !== athleteId); }
                    saveData().then(updateAllUI);
                }
            } else if (e.target.closest('.gps-btn')) {
                document.getElementById('modal-athlete-name-gps').textContent = athlete.name;
                const gpsForm = document.getElementById('gps-form');
                gpsForm.reset();
                gpsForm.querySelector('#modal-athlete-id-gps').value = athlete.id;
                gpsForm.querySelector('#gps-data_di_registrazione').valueAsDate = new Date();

                const sessionSelector = document.getElementById('gps-session-selector');
                sessionSelector.innerHTML = '<option value="">--- Inserisci Nuova Sessione ---</option>';
                const athleteGpsData = gpsData[athlete.id] || {};
                const sortedDates = Object.keys(athleteGpsData).sort().reverse();
                sortedDates.forEach(date => {
                    const session = athleteGpsData[date];
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = `${new Date(date).toLocaleDateString('it-IT')} - ${session.tipo_sessione || 'N/A'}`;
                    sessionSelector.appendChild(option);
                });
                document.getElementById('delete-gps-session-btn').disabled = true;

                gpsModal.show();
            } else if (e.target.closest('.athlete-card-clickable')) {
                const date = elements.evaluationDatePicker.value;
                if (date) {
                    document.getElementById('modal-athlete-name-eval').textContent = athlete.name;
                    document.getElementById('modal-athlete-id-eval').value = athlete.id;
                    document.getElementById('modal-evaluation-date').textContent = new Date(date).toLocaleDateString('it-IT');
                    const existingEvaluation = evaluations[date]?.[athleteId] || {};
                    evaluationCategories.forEach(category => { document.getElementById(category).value = existingEvaluation[category] || '0'; });
                    document.getElementById('award-checkbox').checked = !!(awards[date]?.find(a => a.athleteId.toString() === athleteId));
                    evaluationModal.show();
                }
            }
        });

        elements.athleteForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const athleteId = document.getElementById('modal-athlete-id').value;
            const athleteData = { name: document.getElementById('athlete-name').value.trim(), avatar: document.getElementById('athlete-avatar').value.trim(), role: document.getElementById('athlete-role').value.trim(), number: parseInt(document.getElementById('athlete-number').value), isCaptain: document.getElementById('athlete-captain').checked };
            if (athleteId) { const index = athletes.findIndex(a => a.id.toString() === athleteId); if (index !== -1) athletes[index] = { ...athletes[index], ...athleteData }; } 
            else { athleteData.id = Date.now(); athletes.push(athleteData); }
            saveData().then(updateAllUI);
            athleteModal.hide();
        });

        elements.evaluationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const athleteId = document.getElementById('modal-athlete-id-eval').value;
            const date = elements.evaluationDatePicker.value;
            if (!date) { alert('Per favore, seleziona una data valida prima di salvare.'); return; }
            if (!evaluations[date]) evaluations[date] = {};
            evaluations[date][athleteId] = evaluationCategories.reduce((obj, cat) => ({ ...obj, [cat]: document.getElementById(cat).value }), {});
            if (document.getElementById('award-checkbox').checked) { const reason = prompt('Motivo del premio:'); if (reason) { if (!awards[date]) awards[date] = []; awards[date] = awards[date].filter(a => a.athleteId.toString() !== athleteId); awards[date].push({ athleteId, reason, date }); } } 
            else { if (awards[date]) awards[date] = awards[date].filter(a => a.athleteId.toString() !== athleteId); }
            saveData().then(updateAllUI);
            evaluationModal.hide();
        });

        elements.gpsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const athleteId = document.getElementById('modal-athlete-id-gps').value;
            const date = document.getElementById('gps-data_di_registrazione').value;
            if (!date) {
                alert("Per favore, inserisci una data di registrazione valida.");
                return;
            }
            const gpsFormData = {};

            allGpsFields.forEach(field => {
                const el = document.getElementById(`gps-${field}`);
                if(el) {
                    const value = el.value.trim();
                    if(value !== '') gpsFormData[field] = el.type === 'number' ? parseFloat(value) : value;
                }
            });

            const dist = parseFloat(document.getElementById('gps-distanza_totale').value) || 0;
            const time = parseFloat(document.getElementById('gps-tempo_totale').value) || 0;
            if (dist > 0 && time > 0) gpsFormData.distanza_per_minuto = parseFloat((dist / time).toFixed(2));

            const distC = parseFloat(document.getElementById('gps-distanza_circuito').value) || 0;
            const minC = parseInt(document.getElementById('gps-tempo_circuito_min').value) || 0;
            const secC = parseInt(document.getElementById('gps-tempo_circuito_sec').value) || 0;
            const cenC = parseInt(document.getElementById('gps-tempo_circuito_cen').value) || 0;
            const totalTimeSecC = minC * 60 + secC + cenC / 100;

            if (totalTimeSecC > 0) {
                gpsFormData.tempo_circuito_totale_s = totalTimeSecC;
                if (distC > 0) gpsFormData.velocita_circuito = parseFloat(((distC / totalTimeSecC) * 3.6).toFixed(2));
            }

            if (!gpsData[athleteId]) gpsData[athleteId] = {};
            gpsData[athleteId][date] = gpsFormData;
            saveData().then(updateAllUI);
            gpsModal.hide();
        });

        ['gps-distanza_totale', 'gps-tempo_totale'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', () => {
                const dist = parseFloat(document.getElementById('gps-distanza_totale').value) || 0;
                const time = parseFloat(document.getElementById('gps-tempo_totale').value) || 0;
                document.getElementById('gps-distanza_per_minuto').value = (time > 0) ? (dist / time).toFixed(2) : '';
            });
        });
        ['gps-distanza_circuito', 'gps-tempo_circuito_min', 'gps-tempo_circuito_sec', 'gps-tempo_circuito_cen'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', () => {
                const dist = parseFloat(document.getElementById('gps-distanza_circuito').value) || 0;
                const min = parseInt(document.getElementById('gps-tempo_circuito_min').value) || 0;
                const sec = parseInt(document.getElementById('gps-tempo_circuito_sec').value) || 0;
                const cen = parseInt(document.getElementById('gps-tempo_circuito_cen').value) || 0;
                const totalTimeSec = min * 60 + sec + cen / 100;
                document.getElementById('gps-velocita_circuito').value = (dist > 0 && totalTimeSec > 0) ? ((dist / totalTimeSec) * 3.6).toFixed(2) : '';
            });
        });

        elements.performanceSelectorsContainer.addEventListener('change', (e) => { if (e.target.matches('.athlete-selector, .date-selector')) { const index = parseInt(e.target.dataset.index); const row = e.target.closest('.row'); performanceSelections[index].athleteId = row.querySelector('.athlete-selector').value; performanceSelections[index].date = row.querySelector('.date-selector').value; if(e.target.matches('.athlete-selector')) { populatePerformanceSelectors(); updatePerformanceChart(); } else { updatePerformanceChart(); } } });
        elements.performanceSelectorsContainer.addEventListener('click', (e) => { const removeBtn = e.target.closest('.remove-selector'); if (removeBtn) { performanceSelections.splice(parseInt(removeBtn.dataset.index), 1); populatePerformanceSelectors(); updatePerformanceChart(); } });
        elements.addComparisonBtn.addEventListener('click', () => { performanceSelections.push({ athleteId: null, date: null }); populatePerformanceSelectors(); });
        elements.metricSelector.addEventListener('change', updatePerformanceChart);

        elements.trendAthleteSelector.addEventListener('change', updateAthleteTrendChart);
        elements.trendMetricSelector.addEventListener('change', updateAthleteTrendChart);
        elements.radarAthleteSelector1.addEventListener('change', updateAthleteRadarChart);
        elements.radarAthleteSelector2.addEventListener('change', updateAthleteRadarChart);

        elements.multiAthleteTimeFilter.addEventListener('click', e => {
            if(e.target.tagName === 'BUTTON'){
                elements.multiAthleteTimeFilter.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                elements.multiAthleteDatepickerContainer.style.display = (e.target.dataset.period === 'day') ? 'block' : 'none';
                if(e.target.dataset.period === 'day'){
                   elements.multiAthleteDatepicker.closest('.col-md-3').classList.remove('d-none');
                } else {
                   elements.multiAthleteDatepicker.closest('.col-md-3').classList.add('d-none');
                }
                updateMultiAthleteChart();
            }
        });
        elements.multiAthleteMetricSelector.addEventListener('change', updateMultiAthleteChart);
        elements.multiAthleteDatepicker.addEventListener('change', updateMultiAthleteChart);
        elements.multiAthleteResetBtn.addEventListener('click', () => {
            elements.multiAthleteTimeFilter.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            elements.multiAthleteTimeFilter.querySelector('.btn[data-period="month"]').classList.add('active');
            elements.multiAthleteDatepicker.value = '';
            elements.multiAthleteDatepickerContainer.style.display = 'none';
            elements.multiAthleteMetricSelector.selectedIndex = 0;
            elements.multiAthleteTypeSelector.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            elements.multiAthleteTypeSelector.querySelector('.btn[data-type="all"]').classList.add('active');
            multiAthleteFilterType = 'all';
            updateMultiAthleteChart();
        });

        elements.deleteDayDataBtn.addEventListener('click', () => {
            const date = elements.evaluationDatePicker.value;
            if (!date) {
                alert('Per favore, seleziona una data per poter eliminare i relativi dati.');
                return;
            }

            const formattedDate = new Date(date).toLocaleDateString('it-IT');
            if (confirm(`Sei sicuro di voler eliminare TUTTI i dati (valutazioni, GPS e premi) del giorno ${formattedDate}? L'azione è irreversibile.`)) {

                if (evaluations[date]) {
                    delete evaluations[date];
                }

                if (awards[date]) {
                    delete awards[date];
                }

                Object.keys(gpsData).forEach(athleteId => {
                    if (gpsData[athleteId] && gpsData[athleteId][date]) {
                        delete gpsData[athleteId][date];
                    }
                });

                saveData().then(updateAllUI);

                alert(`Tutti i dati del giorno ${formattedDate} sono stati eliminati.`);
            }
        });

        modalsContainer.addEventListener('click', (e) => {
            if (e.target.id === 'delete-single-athlete-day-btn') {
                const athleteId = document.getElementById('modal-athlete-id-eval').value;
                const date = elements.evaluationDatePicker.value;
                const athlete = athletes.find(a => a.id.toString() === athleteId);

                if (!athleteId || !date || !athlete) {
                    alert("Errore: Impossibile trovare i dati necessari per l'eliminazione.");
                    return;
                }

                const formattedDate = new Date(date).toLocaleDateString('it-IT');
                if (confirm(`Sei sicuro di voler eliminare tutti i dati di ${athlete.name} per il giorno ${formattedDate}?`)) {

                    if (evaluations[date] && evaluations[date][athleteId]) {
                        delete evaluations[date][athleteId];
                    }

                    if (gpsData[athleteId] && gpsData[athleteId][date]) {
                        delete gpsData[athleteId][date];
                    }

                    if (awards[date]) {
                        awards[date] = awards[date].filter(a => a.athleteId.toString() !== athleteId.toString());
                        if (awards[date].length === 0) {
                            delete awards[date];
                        }
                    }

                    saveData().then(() => {
                        evaluationModal.hide();
                        updateAllUI();
                        alert(`Dati di ${athlete.name} per il giorno ${formattedDate} eliminati.`);
                    });
                }
            }
            if (e.target.id === 'delete-gps-session-btn') {
                const athleteId = document.getElementById('modal-athlete-id-gps').value;
                const date = document.getElementById('gps-session-selector').value;
                const athlete = athletes.find(a => a.id.toString() === athleteId);

                if (!date || !athlete) {
                    alert('Nessuna sessione valida selezionata per l\'eliminazione.');
                    return;
                }

                if (confirm(`Sei sicuro di voler eliminare questa sessione di ${athlete.name} del ${new Date(date).toLocaleDateString('it-IT')}?`)) {
                    if(gpsData[athleteId] && gpsData[athleteId][date]){
                        delete gpsData[athleteId][date];
                        saveData().then(() => {
                            gpsModal.hide();
                            updateAllUI();
                        });
                    }
                }
            }
        });

        modalsContainer.addEventListener('change', (e) => {
            if (e.target.id === 'gps-session-selector') {
                const athleteId = document.getElementById('modal-athlete-id-gps').value;
                const date = e.target.value;
                const form = document.getElementById('gps-form');
                const deleteBtn = document.getElementById('delete-gps-session-btn');

                if (date && athleteId && gpsData[athleteId] && gpsData[athleteId][date]) {
                    const data = gpsData[athleteId][date];
                    allGpsFields.forEach(field => {
                        const el = form.querySelector(`#gps-${field}`);
                        if (el) { el.value = data[field] ?? ''; }
                    });

                    const totalSec = data.tempo_circuito_totale_s || 0;
                    form.querySelector('#gps-tempo_circuito_min').value = totalSec > 0 ? Math.floor(totalSec / 60) : '';
                    form.querySelector('#gps-tempo_circuito_sec').value = totalSec > 0 ? Math.floor(totalSec % 60) : '';
                    form.querySelector('#gps-tempo_circuito_cen').value = totalSec > 0 ? Math.round((totalSec - Math.floor(totalSec)) * 100) : '';

                    deleteBtn.disabled = false;
                } else {
                    form.reset();
                    form.querySelector('#gps-data_di_registrazione').valueAsDate = new Date();
                    deleteBtn.disabled = true;
                }
            }
        });

        elements.exportAllDataBtn.addEventListener('click', () => {
            const allData = { athletes, evaluations, gpsData, awards };
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `coach_dashboard_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        elements.importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = (event) => {
                if (confirm("ATTENZIONE: L'importazione sovrascriverà tutti i dati attuali. Vuoi continuare?")) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData && typeof importedData === 'object' && 'athletes' in importedData && 'evaluations' in importedData) {
                            athletes = importedData.athletes || [];
                            evaluations = importedData.evaluations || {};
                            gpsData = importedData.gpsData || {};
                            awards = importedData.awards || {};

                            saveData().then(() => {
                                updateAllUI();
                                alert('Dati importati con successo!');
                            });
                        } else {
                            alert('Errore: Il file non sembra avere il formato corretto.');
                        }
                    } catch (error) {
                        alert(`Errore durante la lettura del file JSON: ${error.message}`);
                    }
                }
            };
            reader.readAsText(file);
            e.target.value = null;
        });

        elements.performanceFilterToggle.addEventListener('click', (e) => {
            if (e.target.matches('.btn')) {
                elements.performanceFilterToggle.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                performanceFilterType = e.target.dataset.type;
                populatePerformanceSelectors();
            }
        });

        elements.multiAthleteTypeSelector.addEventListener('click', (e) => {
            if (e.target.matches('.btn')) {
                elements.multiAthleteTypeSelector.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                multiAthleteFilterType = e.target.dataset.type;
                updateMultiAthleteChart();
            }
        });

        document.addEventListener('click', (e) => {
            const exportExcelBtn = e.target.closest('#export-excel');
            const exportPdfBtn = e.target.closest('#export-pdf');
            if (exportExcelBtn) {
                const validSelections = performanceSelections.filter(s => s.athleteId && s.date); if (validSelections.length === 0) return;
                const data = validSelections.map(selection => { const athlete = athletes.find(a => a.id.toString() === selection.athleteId.toString()); const gpsRecord = gpsData[selection.athleteId]?.[selection.date] || {}; const row = { Atleta: athlete?.name || 'N/A', Data: new Date(selection.date).toLocaleDateString('it-IT') }; Object.entries(gpsFieldsForDisplay).forEach(([key, label]) => { row[label] = gpsRecord[key] ?? 'N/A'; }); return row; });
                const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Performance"); XLSX.writeFile(wb, `performance_${new Date().toISOString().split('T')[0]}.xlsx`);
            } else if (exportPdfBtn) {
                const validSelections = performanceSelections.filter(s => s.athleteId && s.date); if (validSelections.length === 0) return;
                const { jsPDF } = window.jspdf; const doc = new jsPDF({orientation: 'landscape'});
                const head = ['Atleta', 'Data', ...Object.values(gpsFieldsForDisplay)];
                const body = validSelections.map(selection => { const athlete = athletes.find(a => a.id.toString() === selection.athleteId.toString()); const gpsRecord = gpsData[selection.athleteId]?.[selection.date] || {}; return [ athlete?.name || 'N/A', new Date(selection.date).toLocaleDateString('it-IT'), ...Object.keys(gpsFieldsForDisplay).map(key => gpsRecord[key] ?? 'N/A') ]; });
                doc.autoTable({ head: [head], body, styles: { fontSize: 6 }, headStyles: { fillColor: [10, 36, 99] }, columnStyles: { 0: {cellWidth: 20}, 1: {cellWidth: 18} } });
                doc.save(`performance_${new Date().toISOString().split('T')[0]}.pdf`);
            }
        });

        async function initializeApp() {
            await loadData();
            updateAllUI();

            setInterval(async () => {
                const currentDataSnapshot = JSON.stringify({ athletes, evaluations, gpsData, awards });
                await loadData();
                const newDataSnapshot = JSON.stringify({ athletes, evaluations, gpsData, awards });

                if (currentDataSnapshot !== newDataSnapshot) {
                    console.log("Dati aggiornati dal server. Ricarico l'interfaccia.");
                    updateAllUI();
                }
            }, 5000);

            elements.evaluationDatePicker.valueAsDate = new Date();
            elements.multiAthleteDatepicker.valueAsDate = new Date();
        }

        initializeApp();
    });
    </script>
</body>
</html>